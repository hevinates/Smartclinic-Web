@model List<smartclinic_web.Models.Message>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.BodyClass = "patient-bg";
}

<style>
    .patient-bg {
        background-image: url('/images/patient_bg.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .page-header {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        margin-bottom: 40px;
        position: relative;
        box-shadow: 0px 4px 20px rgba(0,0,0,0.08);
    }

    .back-button {
        position: absolute;
        left: 30px;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0px 2px 10px rgba(0,0,0,0.1);
        text-decoration: none;
        color: #0f837d;
        font-size: 20px;
    }

    .back-button:hover {
        background: #0f837d;
        color: white;
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0px 4px 15px rgba(15, 131, 125, 0.3);
    }

    .page-title {
        color: #0f837d;
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 0;
        text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
    }

    .back-btn {
        display: none;
    }

    .messages-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        display: flex;
        height: 600px;
    }

    .chat-header {
        background: linear-gradient(135deg, #0f837d 0%, #0c6963 100%);
        color: white;
        padding: 20px;
        border-radius: 15px 15px 0 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .doctor-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: white;
        color: #0f837d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 700;
    }

    .doctor-info h3 {
        margin: 0;
        font-size: 20px;
    }

    .doctor-info p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 14px;
    }

    .chat-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
    }

    .message {
        display: flex;
        margin-bottom: 20px;
    }

    .message.sent {
        justify-content: flex-end;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 18px;
        position: relative;
    }

    .message.received .message-bubble {
        background: white;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 4px;
    }

    .message.sent .message-bubble {
        background: #0f837d;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-content {
        margin-bottom: 5px;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .message-time {
        font-size: 11px;
        opacity: 0.7;
    }

    .message-type-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .message-type-appointment {
        background: #fff3cd;
        color: #856404;
    }

    .message-type-approval {
        background: #d4edda;
        color: #155724;
    }

    .chat-footer {
        padding: 20px;
        background: white;
        border-top: 1px solid #e9ecef;
        border-radius: 0 0 15px 15px;
    }

    .message-input-group {
        display: flex;
        gap: 10px;
    }

    .message-input {
        flex: 1;
        padding: 12px 18px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 14px;
        transition: 0.2s ease;
    }

    .message-input:focus {
        border-color: #0f837d;
        outline: none;
    }

    .send-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #0f837d;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: 0.2s ease;
    }

    .send-btn:hover {
        background: #0c6963;
        transform: scale(1.1);
    }

    .no-doctor-message {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .no-doctor-message i {
        font-size: 60px;
        color: #0f837d;
        margin-bottom: 20px;
    }

    .back-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 45px;
        height: 45px;
        background-color: #0f837d;
        color: white;
        text-decoration: none;
        border-radius: 50%;
        font-size: 20px;
        transition: 0.2s ease;
        position: fixed;
        left: 30px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1000;
    }

    .back-btn:hover {
        background-color: #0c6963;
        transform: translateY(-50%) scale(1.1);
        color: white;
    }
</style>

<div class="container">
    <div class="page-header">
        <a href="/Patient/Dashboard" class="back-button">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <h2 class="page-title">Mesajlar</h2>
    </div>

    <div class="messages-container">
        @if (ViewBag.DoctorInfo != null)
        {
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="chat-header">
                    <div class="doctor-avatar">
                        <i class="fa-solid fa-user-doctor"></i>
                    </div>
                    <div class="doctor-info">
                        <h3>Dr. @ViewBag.DoctorInfo.Name @ViewBag.DoctorInfo.Surname</h3>
                        <p>@ViewBag.DoctorInfo.DoctorHospital</p>
                    </div>
                </div>

                <div class="chat-body" id="chatBody">
                    @if (Model.Count == 0)
                    {
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <i class="fa-solid fa-comment-slash" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>HenÃ¼z mesaj yok. Ä°lk mesajÄ± gÃ¶ndererek sohbete baÅŸlayÄ±n!</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var message in Model)
                        {
                            <div class="message @(message.SenderId == ViewBag.CurrentUserId ? "sent" : "received")">
                                <div class="message-bubble">
                                    @if (!string.IsNullOrEmpty(message.MessageType) && message.MessageType != "Normal")
                                    {
                                        <div class="message-type-badge @(message.MessageType == "AppointmentRequest" ? "message-type-appointment" : "message-type-approval")">
                                            @(message.MessageType == "AppointmentRequest" ? "ðŸ“… Randevu Talebi" : "âœ… Randevu OnayÄ±")
                                        </div>
                                    }
                                    <div class="message-content">@message.Content</div>
                                    <div class="message-time">@message.SentAt.ToString("HH:mm")</div>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="chat-footer">
                    <div class="message-input-group">
                        <input type="text" class="message-input" id="messageInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." />
                        <button class="send-btn" onclick="sendMessage()">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="no-doctor-message" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <i class="fa-solid fa-user-doctor-slash"></i>
                <h3>Doktor SeÃ§ilmedi</h3>
                <p>MesajlaÅŸmaya baÅŸlamak iÃ§in Ã¶nce profilinizden bir doktor seÃ§melisiniz.</p>
                <a href="/Patient/Profile/@ViewBag.CurrentUserId" style="margin-top: 20px; padding: 12px 30px; background: #0f837d; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                    Profili DÃ¼zenle
                </a>
            </div>
        }
    </div>
</div>

@if (ViewBag.DoctorInfo != null)
{
    <script>
        const receiverId = @ViewBag.DoctorId;
        const currentUserId = @ViewBag.CurrentUserId;

        // Mesaj gÃ¶nder
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            fetch('/Patient/SendMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `receiverId=${receiverId}&content=${encodeURIComponent(content)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // MesajÄ± ekrana ekle
                    const chatBody = document.getElementById('chatBody');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message sent';
                    messageDiv.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-content">${escapeHtml(content)}</div>
                            <div class="message-time">${new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    `;
                    chatBody.appendChild(messageDiv);
                    chatBody.scrollTop = chatBody.scrollHeight;

                    // Input'u temizle
                    input.value = '';
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Enter ile mesaj gÃ¶nder
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // HTML escape
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Sayfa yÃ¼klendiÄŸinde en alta scroll
        window.onload = function() {
            const chatBody = document.getElementById('chatBody');
            chatBody.scrollTop = chatBody.scrollHeight;

            // MesajlarÄ± okundu iÅŸaretle
            if (receiverId) {
                fetch('/Patient/MarkMessagesAsRead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `senderId=${receiverId}`
                });
            }
        };

        // 5 saniyede bir yeni mesajlarÄ± kontrol et
        setInterval(function() {
            location.reload();
        }, 5000);
    </script>
}
